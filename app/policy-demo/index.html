<!doctype html><meta charset="utf-8">
<title>CoAgent • Policy Track (Offline Demo)</title>
<link rel="icon" href="../assets/favicon.ico">
<link rel="stylesheet" href="../assets/style.css">
<header><img src="../assets/logo.png" alt="logo"><h1>Policy Track (Demo)</h1></header>
<main data-panel-id="ai" data-title="AI panel" class="panel">
  <div class="card">
    <h2 style="margin:0 0 6px 0;">Propose a neighborhood idea</h2>
    <form id="f" style="display:grid;gap:10px;max-width:680px">
      <label> Title <input required name="title" style="width:100%"></label>
      <label> Area / street(s) <input name="area" style="width:100%"></label>
      <label> Description <textarea required name="desc" rows="5" style="width:100%"></textarea></label>
      <label> Tags (comma-separated) <input name="tags" style="width:100%"></label>
      <button class="btn primary" type="submit">Preview</button>
    </form>
  </div>
  <div class="card" id="out" style="display:none">
    <h3 style="margin:0 0 6px 0;">Preview</h3>
    <div id="card"></div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <a class="btn" href="./index.html">Edit</a>
      <a class="btn primary" id="finish">Looks good</a>
    </div>
  </div>
</main>
<script src="../logger.js"></script>
<script>
const f=document.querySelector('#f'), out=document.querySelector('#out'), card=document.querySelector('#card');
f.onsubmit=(e)=>{e.preventDefault();
  const d=Object.fromEntries(new FormData(f).entries());
  card.innerHTML = `
    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px">
      <div style="font-weight:600;margin-bottom:6px">${d.title||'(untitled)'} ${d.area?`• <span style="color:#64748b">${d.area}</span>`:''}</div>
      <div style="white-space:pre-wrap;margin-bottom:6px">${(d.desc||'').trim()}</div>
      ${d.tags?`<div class="status">tags: ${d.tags}</div>`:''}
    </div>`;
  f.style.display='none'; out.style.display='block';
};
document.querySelector('#finish').onclick=()=>{
  alert('Saved locally for demo. Connected mode will submit into your CoCivium sandbox.');
};
</script>
<script>
// connected submit helper (no-op offline)
async function sandboxSubmit(payload){
  const root = location.pathname.includes("/policy-demo/") ? "../" : "./";
  let cfg = { mode: "offline", sandboxUrl: "" };
  try { cfg = await fetch(root + "config.json").then(r=>r.json()); } catch {}
  let mode = "offline";
  try { mode = localStorage.getItem("coagent.sandbox.mode") || (cfg.mode==="online"?"online":"offline"); } catch {}
  if (mode !== "online" || !cfg.sandboxUrl) return {ok:false, offline:true};

  try {
    const res = await fetch(cfg.sandboxUrl, {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ type:"policy_idea", ts: new Date().toISOString(), data: payload })
    });
    return res.ok ? {ok:true} : {ok:false};
  } catch { return {ok:false}; }
}
(() => {
  const finish = document.querySelector("#finish");
  const formEl = document.querySelector("#f");
  if (!finish || !formEl) return;

  finish.addEventListener("click", async () => {
    const d = Object.fromEntries(new FormData(formEl).entries());
    const payload = {
      title: d.title || "", area: d.area || "",
      desc: (d.desc || "").trim(),
      tags: (d.tags || "").split(",").map(t=>t.trim()).filter(Boolean)
    };
    let res; try {
      window.CoLog?.log("policy_submit_start", { titleChars: payload.title.length });
      res = await sandboxSubmit(payload);
    } finally {
      window.CoLog?.log("policy_submit_finish", { ok: !!res?.ok, offline: !!res?.offline });
    }
    if (res?.offline)      alert("Saved locally (demo). Enable Sandbox to submit to CoCivium.");
    else if (res?.ok)      alert("Submitted to CoCivium sandbox. Thank you!");
    else                   alert("Could not submit right now. It will stay local.");
  });
})();
</script>








